<html>
  <head>
    <style>
      #holder { border: 10px dashed #ccc; width: 300px; height: 300px; margin: 20px auto;}
      #holder.hover { border: 10px dashed #333; }
    </style>
  </head>
  <body>
    <div id="holder">
    </div>
    <p id="status">File API &amp; FileReader API not supported</p>
    <a id="downloadlink" href="#" download="mylocations.geojson">Drop file first!!</a>
    <script>
      var holder = document.getElementById('holder'),
      state = document.getElementById('status');
      var geojson;

      if (typeof window.FileReader === 'undefined') {
        state.className = 'fail';
      } else {
        state.className = 'success';
        state.innerHTML = 'File API & FileReader available';
      }

      holder.ondragover = function () { this.className = 'hover'; return false; };
      holder.ondragend = function () { this.className = ''; return false; };

      holder.ondrop = function (e) {
        this.className = '';
        e.preventDefault();

        var file = e.dataTransfer.files[0],
        reader = new FileReader();
        reader.onload = function (event) {
          var data = JSON.parse(event.target.result);
          var history = data.locations;
          var lasttime;
          geojson = {"type": "FeatureCollection", "features": [] };
          for (var i = 0, len = history.length; i < len; i++) {
            var h = history[i];
            var coordinates;
            if (lasttime - h.timestampMs > 300000) {
              coordinates = [ h.longitudeE7/10000000 , h.latitudeE7/10000000 ]; 
              geojson.features.push(
               { 
                 "type": "Feature", 
                 "geometry": { "type":"Point", "coordinates": coordinates },
                 "properties": { "date" : '"'+ new Date(Number(h.timestampMs)) + '"' }
               }
              );
            }
            lasttime = h.timestampMs;
          }
          var bb = new Blob([JSON.stringify(geojson)], {type: 'application/json'});
          var a = document.querySelector('#downloadlink');
          a.href = window.URL.createObjectURL(bb);
          a.textContent = 'Download Ready';
        };

        reader.readAsText(file);

        return false;
    };
    </script>
  </body>
</html>
